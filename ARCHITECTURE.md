# 投资估值系统 - 架构设计文档

## 1. 系统概述

### 1.1 设计目标

- **专业性**：提供符合投资机构标准的估值方法
- **完整性**：覆盖相对估值、绝对估值、情景分析、压力测试全流程
- **可扩展性**：模块化设计，易于添加新的估值方法
- **易用性**：提供API、命令行、前端多种使用方式

### 1.2 技术选型

| 层级 | 技术选择 | 理由 |
|------|---------|------|
| 后端框架 | FastAPI | 高性能、自动文档生成、类型验证 |
| 数据处理 | NumPy + Pandas | 数值计算高效、数据处理便捷 |
| 数据源 | Tushare | A股数据权威、接口稳定 |
| 前端框架 | Vue.js 3 | 组件化、生态完善、学习曲线平缓 |
| 图表库 | ECharts | 功能强大、中文友好、定制性强 |

---

## 2. 架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        表现层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Vue.js SPA  │  │  API文档     │  │  命令行工具  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        API网关层                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              FastAPI Application                      │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │  │
│  │  │   路由     │  │  数据验证  │  │   CORS     │     │  │
│  │  └────────────┘  └────────────┘  └────────────┘     │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                            │
│  ┌──────────────┬──────────────┬──────────────┬─────────┐ │
│  │  估值引擎    │  风险分析    │  数据获取    │  工具   │ │
│  │              │              │              │         │ │
│  │ - 相对估值   │ - 情景分析   │ - Tushare    │ - 报告  │ │
│  │ - 绝对估值   │ - 压力测试   │   API        │ - 日志  │ │
│  │ - 其他方法   │ - 敏感性     │              │         │ │
│  └──────────────┴──────────────┴──────────────┴─────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        领域模型层                            │
│  Company, Comparable, ValuationResult, ScenarioConfig, ... │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心设计原则

#### 2.2.1 单一职责原则
每个模块只负责一个估值方法或功能域：
- `relative_valuation.py`：只处理相对估值逻辑
- `absolute_valuation.py`：只处理DCF估值
- `scenario_analysis.py`：只处理情景分析

#### 2.2.2 依赖倒置原则
业务逻辑层依赖于抽象的模型接口，而非具体实现：

```python
def valuation_method(company: Company) -> ValuationResult:
    """所有估值方法的统一接口"""
    pass
```

#### 2.2.3 开闭原则
系统对扩展开放，对修改关闭：
- 添加新估值方法时，只需新增模块，不需要修改现有代码
- 通过继承和组合实现功能扩展

---

## 3. 核心模块设计

### 3.1 模型层 (models.py)

**设计思路**：
- 使用 `@dataclass` 定义不可变的数据结构
- 所有领域模型继承自 `to_dict()` 方法，支持序列化
- 枚举类型用于固定值域（如公司发展阶段）

**关键类关系**：

```
Company (公司)
    │
    ├── ValuationResult (估值结果)
    │       │
    │       ├── value (估值的点估计)
    │       ├── value_low (估值下限)
    │       └── value_high (估值上限)
    │
    ├── ScenarioConfig (情景配置)
    │       │
    │       ├── base_case (基准情景)
    │       ├── bull_case (乐观情景)
    │       └── bear_case (悲观情景)
    │
    └── StressTestResult (压力测试结果)
            │
            ├── base_value (基准估值)
            ├── stressed_value (压力情景估值)
            └── change_pct (变化百分比)
```

### 3.2 估值引擎架构

```
┌─────────────────────────────────────────────────────────────┐
│                     ValuationEngine                         │
│                  (统一估值引擎入口)                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │  Relative   │  Absolute   │    Other    │   Cross     │ │
│  │  Valuation  │  Valuation  │   Methods   │ Validation  │ │
│  │             │             │             │             │ │
│  │ - PE Ratio  │ - DCF       │ - VC Method │             │ │
│  │ - PS Ratio  │ - WACC      │ - Cost      │             │ │
│  │ - PB Ratio  │ - Terminal  │ - Trans.    │             │ │
│  │ - EV/EBITDA │   Value     │             │             │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
│                                                               │
│  公共功能：                                                    │
│  - 可比公司筛选                                               │
│  - 倍数统计计算                                               │
│  - 估值区间生成                                               │
│  - 结果交叉验证                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 风险分析架构

```
┌─────────────────────────────────────────────────────────────┐
│                    RiskAnalysisEngine                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────┬──────────────────────────────────┐ │
│  │  ScenarioAnalyzer  │      StressTester               │ │
│  │                    │                                  │ │
│  │ - 基准情景         │ - 收入冲击测试                  │ │
│  │ - 乐观情景         │ - 利润率压缩测试                │ │
│  │ - 悲观情景         │ - WACC冲击测试                  │ │
│  │ - 自定义情景       │ - 极端市场崩溃                  │ │
│  │ - 概率分析         │ - 蒙特卡洛模拟                  │ │
│  └────────────────────┴──────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            SensitivityAnalyzer                         │ │
│  │                                                        │ │
│  │ - 单因素敏感性分析                                      │ │
│  │ - 双因素敏感性分析                                      │ │
│  │ - 龙卷风图数据生成                                      │ │
│  │ - 参数影响排序                                          │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 数据流设计

### 4.1 估值计算流程

```
┌──────────┐
│ 用户输入 │
│ (公司    │
│  财务    │
│  数据)   │
└─────┬────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                    数据验证                            │
│  - 检查必填字段                                         │
│  - 数据类型验证                                          │
│  - 业务逻辑验证（如PE不能为负）                          │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  估值方法选择                          │
│  根据公司阶段自动推荐：                                   │
│  - 早期 → VC法                                          │
│  - 成长期 → P/S法、DCF法                                 │
│  - 成熟期 → P/E法、DCF法                                 │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  参数计算                              │
│  - 计算WACC                                             │
│  - 预测现金流                                           │
│  - 获取可比倍数                                         │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  估值计算                              │
│  - 执行估值算法                                         │
│  - 生成估值区间                                         │
│  - 记录假设条件                                         │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  风险分析                              │
│  - 情景分析                                             │
│  - 压力测试                                             │
│  - 敏感性分析                                           │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  结果汇总                              │
│  - 多方法交叉验证                                       │
│  - 生成估值建议                                         │
│  - 风险提示                                             │
└─────┬─────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────┐
│                  返回结果                              │
│  - JSON格式                                            │
│  - 图表数据                                            │
│  - 分析报告                                            │
└───────────────────────────────────────────────────────┘
```

### 4.2 API请求响应流程

```
┌──────────┐
│  Client  │
└─────┬────┘
      │ HTTP POST /api/valuation/absolute
      │ Body: { company: {...}, params: {...} }
      ▼
┌─────────────────────┐
│     FastAPI        │
│                     │
│  ┌───────────────┐ │
│  │ Pydantic验证  │ │ ← 检查请求格式
│  └───────┬───────┘ │
          │         │
          ▼         │
┌───────────────────┤ │
│  Business Logic   │ │ ← 调用估值模块
│  └─────┬─────────┘ │
│        │           │
│        ▼           │
│  ┌───────────┐    │
│  │  Result   │    │
│  └─────┬─────┘    │
└────────┼──────────┘
         │
         ▼
┌─────────────────────┐
│     Response       │
│  HTTP 200 OK       │
│  {                 │
│    "success": true,│
│    "result": {...} │
│  }                 │
└─────────────────────┘
```

---

## 5. 扩展性设计

### 5.1 新增估值方法

```python
# 1. 在 new_valuation_method.py 中定义
class NewValuationMethod:
    @staticmethod
    def value(company: Company) -> ValuationResult:
        # 实现新方法
        pass

# 2. 在统一引擎中注册
from new_valuation_method import NewValuationMethod

def unified_valuation(company: Company, methods: List[str]):
    if 'NEW_METHOD' in methods:
        result = NewValuationMethod.value(company)
```

### 5.2 新增数据源

```python
class DataFetcherInterface:
    def get_company_data(self, code: str) -> dict:
        raise NotImplementedError

class TushareFetcher(DataFetcherInterface):
    def get_company_data(self, code: str) -> dict:
        # Tushare实现
        pass

class WindFetcher(DataFetcherInterface):
    def get_company_data(self, code: str) -> dict:
        # Wind实现
        pass
```

### 5.3 前端集成

```javascript
// API服务封装
const valuationAPI = {
  // 绝对估值
  dcf: (company) => axios.post('/api/valuation/absolute', company),

  // 相对估值
  relative: (company, comparables) =>
    axios.post('/api/valuation/relative', { company, comparables }),

  // 情景分析
  scenario: (company, scenarios) =>
    axios.post('/api/scenario/analyze', { company, scenarios }),
}
```

---

## 6. 性能考虑

### 6.1 计算优化

- **向量化计算**：使用NumPy进行批量计算
- **缓存机制**：缓存可比公司数据、WACC计算结果
- **异步处理**：API接口使用async/await

### 6.2 蒙特卡洛模拟优化

```python
# 使用NumPy向量化操作
def monte_carlo_optimized(params, iterations=10000):
    # 一次性生成所有随机数
    growth_samples = np.random.normal(growth_mean, growth_std, iterations)
    margin_samples = np.random.normal(margin_mean, margin_std, iterations)
    wacc_samples = np.random.normal(wacc_mean, wacc_std, iterations)

    # 向量化计算
    valuations = vectorized_dcf(growth_samples, margin_samples, wacc_samples)
    return valuations
```

---

## 7. 安全性考虑

### 7.1 API安全

- **输入验证**：Pydantic模型严格验证
- **速率限制**：防止API滥用
- **HTTPS**：生产环境强制HTTPS

### 7.2 数据安全

- **敏感数据**：Tushare Token不暴露在前端
- **访问控制**：API密钥认证（可选）

---

## 8. 部署架构

### 8.1 开发环境

```
┌──────────────┐
│  Vue.js Dev  │ localhost:5173
└──────┬───────┘
       │ CORS
       ▼
┌──────────────┐
│  FastAPI     │ localhost:8000
│  (uvicorn)   │
└──────────────┘
```

### 8.2 生产环境

```
        ┌─────────────┐
        │   Nginx     │ (反向代理 + 静态文件)
        └──────┬──────┘
               │
       ┌───────┴───────┐
       │               │
┌──────▼──────┐  ┌────▼────────┐
│  Vue.js     │  │  FastAPI    │
│  (Build)    │  │  (Docker)   │
└─────────────┘  └─────────────┘
```

---

## 9. 测试策略

### 9.1 单元测试

```python
def test_pe_ratio_valuation():
    company = Company(name="Test", ...)
    comparables = [Comparable(pe_ratio=20), ...]

    result = RelativeValuation.pe_ratio_valuation(company, comparables)

    assert result.value > 0
    assert result.method == "P/E法"
```

### 9.2 集成测试

```python
def test_full_valuation_workflow():
    # 测试完整估值流程
    response = client.post("/api/valuation/compare", json={...})
    assert response.status_code == 200
```

### 9.3 性能测试

- 蒙特卡洛模拟10000次 < 1秒
- API响应时间 < 500ms

---

## 10. 版本规划

### v1.0.0 (当前)
- ✅ 核心估值方法
- ✅ 情景分析
- ✅ 压力测试
- ✅ 敏感性分析
- ✅ API服务

### v1.1.0 (计划)
- ⏳ Vue.js前端
- ⏳ 可视化图表
- ⏳ 估值报告导出

### v2.0.0 (未来)
- ⏳ 多用户支持
- ⏳ 估值案例库
- ⏳ 机器学习辅助
